name: ğŸ“ Procesar Canales Manuales

on:
  # Ejecutar solo manualmente
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Â¿Confirmas el procesamiento? (escribe "si" para continuar)'
        required: true
        default: 'no'
        type: string
      max_channels:
        description: 'MÃ¡ximo de canales a procesar (opcional, deja vacÃ­o para todos)'
        required: false
        default: ''
        type: string

jobs:
  process-manual-channels:
    runs-on: ubuntu-latest
    
    # Solo ejecutar si se confirma
    if: github.event.inputs.confirm == 'si'
    
    steps:
    - name: ğŸš€ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install google-api-python-client openpyxl
    
    - name: ğŸ“ Create directories
      run: |
        mkdir -p data logs cache
        echo "Directorios creados correctamente"
    
    - name: ğŸ” Check files
      run: |
        echo "ğŸ“‹ Archivos disponibles:"
        ls -la
        
        if [ -f "CANALES ARGENTINOS FINALES.xlsx" ]; then
          echo "âœ… Archivo Excel encontrado"
        else
          echo "âŒ Archivo Excel NO encontrado"
          exit 1
        fi
        
        if [ -f "add_manual_channels.py" ]; then
          echo "âœ… Script de procesamiento encontrado"
        else
          echo "âŒ Script de procesamiento NO encontrado"
          exit 1
        fi
    
    - name: ğŸ¤– Process manual channels
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        API_KEY_2: ${{ secrets.API_KEY_2 }}
      run: |
        echo "ğŸš€ Iniciando procesamiento de canales manuales..."
        echo "ğŸ“… Fecha: $(date)"
        
        # Ejecutar script sin confirmaciÃ³n interactiva
        python -c "
import sys
sys.path.insert(0, '.')

# Importar y ejecutar sin input manual
from add_manual_channels import ManualChannelProcessor, load_channel_ids_from_file, Config
from pathlib import Path

# Configurar API key desde environment
import os
if os.getenv('YOUTUBE_API_KEY'):
    Config.YOUTUBE_API_KEY = os.getenv('YOUTUBE_API_KEY')

print('ğŸ” Buscando archivo Excel...')
if Path('CANALES ARGENTINOS FINALES.xlsx').exists():
    print('ğŸ“Š Cargando canales desde Excel...')
    channel_ids = load_channel_ids_from_file('CANALES ARGENTINOS FINALES.xlsx')
    print(f'ğŸ“‹ {len(channel_ids)} canales cargados')
    
    # Limitar canales si se especifica
    max_channels = '${{ github.event.inputs.max_channels }}'
    if max_channels and max_channels.isdigit():
        channel_ids = channel_ids[:int(max_channels)]
        print(f'ğŸ”¢ Limitado a {len(channel_ids)} canales')
    
    # Procesar automÃ¡ticamente
    print('ğŸš€ Iniciando procesamiento...')
    processor = ManualChannelProcessor(channel_ids)
    results = processor.process_all_channels()
    
    print(f'âœ… Completado: {results[\"added\"]} aÃ±adidos, {results[\"rejected\"]} rechazados')
else:
    print('âŒ Archivo Excel no encontrado')
    sys.exit(1)
        "
    
    - name: ğŸ“Š Check results
      id: check_results
      run: |
        if [ -f "data/streamers_argentinos.csv" ]; then
          lines=$(wc -l < data/streamers_argentinos.csv)
          echo "csv_lines=$lines" >> $GITHUB_OUTPUT
          echo "âœ… CSV actualizado con $lines lÃ­neas"
          
          # Mostrar Ãºltimas lÃ­neas aÃ±adidas
          echo "ğŸ“‹ Ãšltimos canales aÃ±adidos:"
          tail -n 5 data/streamers_argentinos.csv | while read line; do
            echo "   $line"
          done
        else
          echo "âŒ No se generÃ³ el archivo CSV"
          echo "csv_lines=0" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ“ˆ Generate summary
      run: |
        echo "## ğŸ“Š Resumen del Procesamiento" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "data/streamers_argentinos.csv" ]; then
          lines=$(wc -l < data/streamers_argentinos.csv)
          echo "**Total en CSV:** $lines lÃ­neas" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ Archivos generados:" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“„ CSV: \`data/streamers_argentinos.csv\`" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“œ Logs: Disponibles en artifacts" >> $GITHUB_STEP_SUMMARY
        
        # Buscar logs recientes
        if [ -d "logs" ] && [ "$(ls -A logs)" ]; then
          latest_log=$(ls -t logs/*.log | head -n 1)
          if [ -f "$latest_log" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ Ãšltimas lÃ­neas del log:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -n 10 "$latest_log" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        fi
    
    - name: ğŸ’¾ Commit and push results
      if: steps.check_results.outputs.csv_lines != '0'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # AÃ±adir archivos generados
        git add data/streamers_argentinos.csv || true
        git add cache/ || true
        git add logs/ || true
        
        # Commit solo si hay cambios
        if ! git diff --staged --quiet; then
          channels_processed="${{ github.event.inputs.max_channels }}"
          if [ -z "$channels_processed" ]; then
            channels_processed="todos"
          fi
          
          git commit -m "ğŸ¤– Canales manuales procesados ($channels_processed) - $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… Cambios guardados en el repositorio"
        else
          echo "â„¹ï¸ No hay cambios nuevos para guardar"
        fi
    
    - name: ğŸ“ Upload artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: processing-results-${{ github.run_id }}
        path: |
          logs/
          data/streamers_argentinos.csv
          cache/
        retention-days: 30
    
    - name: âœ… Success notification
      if: success()
      run: |
        echo "ğŸ‰ Â¡Procesamiento completado exitosamente!"
        echo "ğŸ“ Los resultados estÃ¡n guardados en el repositorio"
        echo "ğŸ“Š Revisa el archivo 'data/streamers_argentinos.csv'"
    
    - name: âŒ Failure notification  
      if: failure()
      run: |
        echo "ğŸ’¥ Hubo un error en el procesamiento"
        echo "ğŸ“œ Revisa los logs en los artifacts para mÃ¡s detalles"
        echo "ğŸ”§ Verifica que la API key estÃ© configurada correctamente"

  # Job que se ejecuta si no se confirma
  confirmation-required:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'si'
    
    steps:
    - name: âš ï¸ Confirmation required
      run: |
        echo "âŒ Procesamiento cancelado"
        echo "Para ejecutar, ve a Actions > ğŸ“ Procesar Canales Manuales > Run workflow"
        echo "Y escribe 'si' en el campo de confirmaciÃ³n"
        exit 1
